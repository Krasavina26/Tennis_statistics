# Tennis Video Analysis System

## Содержание
- [Описание](#описание)
- [Инструкция по запуску](#инструкция-по-запуску)
- [Итоговый результат](#итоговый-результат)
  - [Сохраняемые характеристики](#сохраняемые-характеристики)
- [Обучение моделей](#обучение-моделей)
  - [Выбранные архитектуры](#выбранные-архитектуры)
  - [Датасеты](#датасеты)
  - [Результаты обучения](#результаты-обучения)
- [Реализация](#реализация)
  - [Получение характеристик](#получение-характеристик)
  - [Деление корта на зоны](#деление-корта-на-зоны)

## Описание
Система на основе Computer Vision, позволяющая получать характеристики по видеозаписи игры в теннис двух игроков.

## Инструкция по запуску

1. **Подготовка файлов**
   - Загрузите свои веса моделей в папку `models`
   - Поместите исходное видео в папку `input_videos`

2. **Настройка параметров**
   - Отредактируйте файл `constants/__init__.py`
   - Укажите рост игроков:
     - `PLAYER_1_HEIGHT_METERS` — рост ближайшего к камере игрока
     - `PLAYER_2_HEIGHT_METERS` — рост второго игрока (дальше от камеры)

3. **Запуск**
   - `main.py` — получение характеристик без отрисовки bbox'ов и точек корта
   - `main_with_draw.py` — тот же анализ, но с отладочной информацией


## Итоговый результат

На выходном видео отображается:
- Мини-корт — в правом верхнем углу
- Табло со скоростями игроков — в правом нижнем углу

| Без отладки | С отладкой |
|:-----------:|:----------:|
| <img src="https://github.com/user-attachments/assets/1818eb69-2116-459b-97b4-c27943f17b0a" width="400"> | <img src="https://github.com/user-attachments/assets/d5169401-ac7f-429a-ae84-71a75074c549" width="400"> |

### Сохраняемые характеристики

Система генерирует текстовый файл со следующими метриками:

1. Количество ударов и подач каждого игрока
2. Доли успешных подач каждого игрока
3. Доли двойных ошибок при подачах
4. Количество совершенных розыгрышей
5. Среднее и максимальное число ударов за розыгрыш
6. Длина пробега каждого игрока (в метрах)
7. Средние и максимальные скорости игроков (км/ч)
8. Видео горизонтального мини-корта и карта покрытия корта:

<table>
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/0f2ac705-cfd0-47e8-84fa-c26e597ce27a" width="400">
      <br>
      <em>Мини-корт</em>
    </td>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/4985e427-32e1-4528-9d97-a6ef89c63f8a" width="400">
      <br>
      <em>Карта покрытия корта</em>
    </td>
  </tr>
</table>

---

## Обучение моделей

### Выбранные архитектуры

| Задача | Модель |
|--------|--------|
| Детекция игроков и сетки | `yolov8s` |
| Детекция мяча | `yolov26n` |
| Детекция точек корта | `yolo26s-pose` |

### Датасеты

Датасеты собраны на платформе **Roboflow**. Размечены кадры с любительских видео и профессиональных турниров с разных ракурсов, при разном освещении и в различных локациях.

**Ссылки на датасеты:**
- [Точки корта](https://universe.roboflow.com/tennisa-cort/tennis-detection-uqgca-n2s8p)
- [Мяч](https://universe.roboflow.com/tennis-detection-rxf2c/tennis-only-ball-fsmnu)
- [Сетка и игроки](https://universe.roboflow.com/tennis-detection-rxf2c/tennis-wjzny)

> **Примечание:** Последний датасет содержит 4 класса (сетка, игроки, мяч, ракетки), но количество кадров недостаточно для качественного обучения детекции мелких объектов (мяча и ракеток).

### Результаты обучения

<table>
  <tr>
    <th width="50%">Детекция мяча</th>
    <th width="50%">Детекция игрока, сетки, мяча, ракетки</th>
  </tr>
  <tr>
    <td align="center">
      <img width="600" height="545" alt="Обнаружение мяча" src="https://github.com/user-attachments/assets/3ececfbc-7e53-4116-844f-46486147d936">
    </td>
    <td align="center">
      <img width="600" height="545" alt="Обнаружение объектов" src="https://github.com/user-attachments/assets/7724f28d-77aa-49b8-a357-f3763f15a030">
    </td>
  </tr>
</table>

---

## Реализация

### Получение характеристик
Реализовано на основе правил (**rule-based** подход).

### Деление корта на зоны

> **Важно:** На данный момент учет конкретных зон корта не реализован.

<div align="center">
  <img src="https://github.com/user-attachments/assets/c471d172-cca3-4b20-93ac-42f41b5e86db" width="700">
  <br>
  <em>Рисунок 1 — Точки корта с нумерацией</em>
</div>

> **Примечание:** Моделью детектируются только точки 0-13 включительно. Точки 14-18 определяются в результате деления корта сеткой.

Деление мини-корта происходит по точкам, без дополнительных расчетов. Все зоны с делением сеткой и без представлены ниже на Рисунке 2 и Рисунке 3.

<table>
  <tr>
    <td align="center" width="50%">
      <img width="600" height="303" alt="schema_before" src="https://github.com/user-attachments/assets/e7173268-a01e-4d0e-970a-fd1fad6fdddc">
      <br>
      <em>Рисунок 2 — Схема корта до деления сеткой на зоны</em>
    </td>
    <td align="center" width="50%">
      <img width="600" height="303" alt="schema_after" src="https://github.com/user-attachments/assets/1f0abd97-f88f-48ec-8ce7-55ab7b32695e">
      <br>
      <em>Рисунок 3 — Схема корта после деления сеткой на зоны</em>
    </td>
  </tr>
</table>

#### Алгоритм деления реального корта:

1. Обученная модель детектирует bounding box сетки на кадре
2. Нижняя линия bbox'а принимается за линию сетки
3. Линия сетки корректируется для параллельности другой линии корта (отрезок BC на Рисунке 4)
4. Находятся пересечения линий зон с откорректированной линией сетки

#### Зачем корректировать линию сетки?

При наклоне камеры возникает искажение, которое необходимо компенсировать:

<div align="center">
  <img src="https://github.com/user-attachments/assets/ad45b513-e4eb-412a-a5bf-e67566d580c8" alt="корт_primer" width="700">
  <br>
  <em>Рисунок 4 — Пример определения линии сетки при наклоне камеры</em>
</div>

Без коррекции линия сетки прошла бы по траектории **HP**, тогда как правильная линия — **AP**.

---
